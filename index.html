<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Japanese Vocabulary</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #f9f9f9;
      padding: 2rem;
      color: #333;
    }

    ruby {
    display: inline-block; /* Ensures proper inline rendering */
    font-size: 1em; /* Ensure the ruby and kanji are the same size */
  }
  
  ruby rt {
    font-size: 0.5em; /* Make the furigana smaller */
    vertical-align: middle; /* Align the furigana properly with the kanji */
    color: #555; /* Slightly gray for better readability */
  }
  
  ruby rb {
    font-size: 1em; /* Ensure kanji and furigana are correctly sized */
  }



    h1 {
      text-align: center;
      margin-bottom: 2rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background-color: #f2f2f2;
    }

    tr:hover {
      background-color: #f5f5f5;
    }

    .play-btn {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 14px;
      transition: background 0.3s ease;
    }

    .play-btn:hover {
      background-color: #0056b3;
    }

    .audio-player {
      display: none;
    }

    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }

      th {
        display: none;
      }

      td {
        position: relative;
        padding-left: 50%;
        border: none;
        border-bottom: 1px solid #eee;
      }

      td::before {
        content: attr(data-label);
        position: absolute;
        left: 16px;
        font-weight: bold;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>Japanese Vocabulary</h1>
  <div style="display: flex; justify-content: start; gap: 10px; margin-bottom: 1em;">
    <button onclick="shuffleTable()">üîÄ Shuffle</button>
    <button onclick="startSequentialPlay()">‚ñ∂ Play All</button>
    <button id="pauseResumeBtn" onclick="togglePauseResume()">‚è∏ Pause</button>
    <button onclick="stopSequentialPlay()">‚èπ Stop</button>
    <button onclick="resetTable()">üîÑ Default</button>
  </div>
  
  <table id="vocabTable">
    <thead>
      <tr>
        <th>Hiragana</th>
        <th>Kanji</th>
        <th>English</th>
        <th>Example</th>
        <th>Translation</th>
        <th>Play</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <audio id="audioPlayer" class="audio-player" controls></audio>

  <script>
    let originalTableRows = [];

    function parseFurigana(text) {
  // This regex will match any Kanji followed by its furigana in square brackets.
  return text.replace(/([^\[\]]+)\[([^\[\]]+)\]/g, (_, kanji, furigana) => {
    // Wrap the kanji and its furigana in the <ruby> tag.
    return `<ruby><rb>${kanji}</rb><rt>${furigana}</rt></ruby>`;
  });
}






    async function loadVocabulary() {
  const response = await fetch("verb2.csv");
  const csvText = await response.text();

  const parsed = Papa.parse(csvText, {
    header: true,
    skipEmptyLines: true
  });

  const tableBody = document.querySelector("#vocabTable tbody");

  parsed.data.forEach(row => {
    const hiragana = row["Hiragana"]?.trim().replace(/^"|"$/g, '') || "";
    const kanji = row["Kanji"]?.trim().replace(/^"|"$/g, '') || "";
    const english = row["English"]?.trim().replace(/^"|"$/g, '') || "";
    const example = row["Example"]?.trim().replace(/^"|"$/g, '') || "";
    const translation = row["Translation"]?.trim().replace(/^"|"$/g, '') || "";

    const displayKanji = kanji || hiragana;
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td data-label="Hiragana">${hiragana}</td>
      <td data-label="Kanji">${kanji || "-"}</td>
      <td data-label="English">${english}</td>
      <td data-label="Translation">${translation}</td>
      <td data-label="Play"><button class="play-btn" onclick="playAudio('${encodeURIComponent(displayKanji)}')">‚ñ∂</button></td>
    `;

    // Dynamically add furigana-formatted example
    const exampleCell = document.createElement("td");
    exampleCell.setAttribute("data-label", "Example");
    exampleCell.innerHTML = parseFurigana(example);
    tr.insertBefore(exampleCell, tr.children[3]); // Insert in correct order

    tableBody.appendChild(tr);
  });
}


    function playAudio(text) {
  const audioPlayer = document.getElementById("audioPlayer");
  const basePath = `verb_sound/${text}`;
  
  // Stop and reset any current audio
  audioPlayer.pause();
  audioPlayer.currentTime = 0;
  audioPlayer.src = "";

  // Remove any lingering event listeners
  audioPlayer.onended = null;

  // Step 1: Play Japanese
  audioPlayer.src = `${basePath}.mp3`;
  audioPlayer.play()
    .then(() => {
      // Step 2: After Japanese ends, play English
      audioPlayer.onended = () => {
        audioPlayer.onended = null; // Prevent recursion
        setTimeout(() => {
          audioPlayer.src = `${basePath}_eng.mp3`;
          audioPlayer.play()
            .then(() => {
              // Step 3: Clear onended after English
              audioPlayer.onended = () => {
                audioPlayer.onended = null;
              };
            })
            .catch(err => console.error("Error playing English audio:", err));
        }, 300); // 0.3s delay
      };
    })
    .catch(err => {
      console.error("Error playing Japanese audio:", err);
    });
}


  function resetTable() {
    const tbody = document.querySelector("#vocabTable tbody");
    tbody.innerHTML = "";
    originalTableRows.forEach(row => tbody.appendChild(row.cloneNode(true)));
  }


  function shuffleTable() {
    const tbody = document.querySelector("#vocabTable tbody");
    const rows = Array.from(tbody.querySelectorAll("tr"));

    // Fisher‚ÄìYates shuffle
    for (let i = rows.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [rows[i], rows[j]] = [rows[j], rows[i]];
    }

    // Re-append shuffled rows
    rows.forEach(row => tbody.appendChild(row));
  }

  function playAllSequentially() {
    const rows = document.querySelectorAll("#vocabTable tbody tr");
    const audios = [];

    rows.forEach(row => {
      const button = row.querySelector(".play-btn");
      if (button) {
        const match = button.getAttribute("onclick").match(/playAudio\('(.+)'\)/);
        if (match) {
          audios.push(decodeURIComponent(match[1]));
        }
      }
    });

    let index = 0;
    const audioPlayer = document.getElementById("audioPlayer");

    function playNext() {
      if (index >= audios.length) return;
      const current = audios[index];
      audioPlayer.src = `verb_sound/${current}.mp3`;
      audioPlayer.play().then(() => {
        index++;
        setTimeout(playNext, 500); // 0.5s gap
      }).catch(err => {
        console.error("Audio error:", err);
        index++;
        setTimeout(playNext, 500);
      });
    }

    playNext();
  }

  let sequentialAudioList = [];
  let sequentialIndex = 0;
  let isPaused = false;
  let isStopped = false;

  function startSequentialPlay() {
    const rows = document.querySelectorAll("#vocabTable tbody tr");
    sequentialAudioList = [];

    rows.forEach(row => {
      const button = row.querySelector(".play-btn");
      if (button) {
        const match = button.getAttribute("onclick").match(/playAudio\('(.+)'\)/);
        if (match) {
          sequentialAudioList.push(decodeURIComponent(match[1]));
        }
      }
    });

    isPaused = false;
    isStopped = false;
    sequentialIndex = 0;

    playNextSequential();
  }

  function playNextSequential() {
  if (isStopped || sequentialIndex >= sequentialAudioList.length) return;
  if (isPaused) return;

  const audioPlayer = document.getElementById("audioPlayer");
  const current = sequentialAudioList[sequentialIndex];
  const basePath = `verb_sound/${current}`;

  // Play Japanese audio first
  audioPlayer.src = `${basePath}.mp3`;
  audioPlayer.play().then(() => {
    audioPlayer.onended = () => {
      if (isPaused || isStopped) return;

      // Wait 0.3s ‚Üí play English translation
      setTimeout(() => {
        audioPlayer.src = `${basePath}_eng.mp3`;
        audioPlayer.play().then(() => {
          audioPlayer.onended = () => {
            if (isPaused || isStopped) return;
            sequentialIndex++;
            setTimeout(() => {
              playNextSequential();
            }, 500); // 0.5s after English ends
          };
        }).catch(err => {
          console.error("English audio error:", err);
          // Skip to next
          sequentialIndex++;
          setTimeout(playNextSequential, 500);
        });
      }, 300);
    };
  }).catch(err => {
    console.error("Japanese audio error:", err);
    sequentialIndex++;
    setTimeout(playNextSequential, 500);
  });
}


function stopSequentialPlay() {
  isStopped = true;
  isPaused = false;
  sequentialIndex = 0;
  const audioPlayer = document.getElementById("audioPlayer");
  audioPlayer.pause();
  audioPlayer.currentTime = 0;
  document.getElementById("pauseResumeBtn").textContent = "‚è∏ Pause";
}



  
    loadVocabulary();
  </script>
  
</body>
</html>
